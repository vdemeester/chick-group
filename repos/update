#!/usr/bin/env nix-shell
#! nix-shell -i bash -p curl nix coreutils xmlstarlet go jq
set -euxo pipefail

SCRIPTPATH="$( cd "$(dirname "$0")" ; pwd -P )"
cd $SCRIPTPATH

function update_github_repo() {
    owner=$1
    repo=$2
    branch=$3
    is_go_module=${4:-false}
    test_package=${5:-}  # Package name to test for vendorHash computation
    echo "$repo $branch (go=$is_go_module)"

    # Get relevant data (commit id and timestamp) for the latest commit
    commit_data=$(curl -s "https://github.com/$owner/$repo/commits/$branch.atom" | xmlstarlet sel -N atom="http://www.w3.org/2005/Atom" -t -m /atom:feed/atom:entry -v "concat(atom:id,'/',atom:updated)" -n | head -n 1)

    # Extract commit sha and build a version number based on date: YYYYMMDD.0
    commit_sha=$(echo $commit_data | cut -d '/' -f 2)
    version_number=$(echo $commit_data | cut -d '/' -f 3 | cut -d 'T' -f 1 | sed 's/-//g').0

    output_branch=$(echo $branch | sed s/"\/"/"_"/)
    # Get hash in SRI format (sha256-...)
    digest=$(nix-prefetch-url --unpack "https://github.com/$owner/$repo/archive/${commit_sha}.tar.gz" 2>/dev/null)
    sri_hash=$(nix hash to-sri --type sha256 "$digest")

    if [ "$is_go_module" = "true" ] && [ -n "$test_package" ]; then
        # Write JSON with a fakeHash so the package can be evaluated
        fake_hash="sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
        echo "{\"type\": \"github\", \"owner\": \"${owner}\", \"repo\": \"${repo}\", \"rev\": \"${commit_sha}\", \"sha256\": \"${sri_hash}\", \"version\": \"${version_number}\", \"vendorHash\": \"${fake_hash}\"}" > $repo-$output_branch.json

        # Try to compute vendorHash by building with fakeHash and extracting correct hash
        echo "Computing vendorHash for $test_package..."
        cd "$SCRIPTPATH/.."
        vendor_hash=$(nix build .#${test_package} --no-link 2>&1 | grep "got:" | head -1 | awk '{print $2}' || echo "")
        cd "$SCRIPTPATH"

        if [ -n "$vendor_hash" ]; then
            echo "Computed vendorHash: $vendor_hash"
            echo "{\"type\": \"github\", \"owner\": \"${owner}\", \"repo\": \"${repo}\", \"rev\": \"${commit_sha}\", \"sha256\": \"${sri_hash}\", \"version\": \"${version_number}\", \"vendorHash\": \"${vendor_hash}\"}" > $repo-$output_branch.json
        else
            echo "Warning: Could not compute vendorHash, keeping fakeHash (will need manual fix)"
        fi
    else
        echo "{\"type\": \"github\", \"owner\": \"${owner}\", \"repo\": \"${repo}\", \"rev\": \"${commit_sha}\", \"sha256\": \"${sri_hash}\", \"version\": \"${version_number}\"}" > $repo-$output_branch.json
    fi
}


update_github_repo vc60er deptree main true deptree
update_github_repo openshift-pipelines startpaac main
update_github_repo vdemeester x main true lazypr

