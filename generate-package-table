#!/usr/bin/env nix-shell
#!nix-shell -i bash -p jq

# Generate markdown table of packages from Nix flake and update README.md
#
# Usage:
#   ./generate-package-table
#
# This script automatically updates the package table in README.md
# between the markers:
#   <!-- BEGIN PACKAGE TABLE -->
#   <!-- END PACKAGE TABLE -->

set -euo pipefail

README="README.md"
TEMP_FILE=$(mktemp)

# Generate the package table
generate_table() {
  echo "| Package | Version | Description |"
  echo "|---------|---------|-------------|"

  # Get all package names from the flake
  nix flake show --json 2>/dev/null | \
    jq -r '.packages."x86_64-linux" | keys[]' | \
    sort | \
    while read -r pkg; do
      # Get package metadata
      version=$(nix eval ".#${pkg}.version" --raw 2>/dev/null || echo "unknown")
      description=$(nix eval ".#${pkg}.meta.description" --raw 2>/dev/null || echo "")
      homepage=$(nix eval ".#${pkg}.meta.homepage" --raw 2>/dev/null || echo "")

      # Format package name as link if homepage exists
      if [ -n "$homepage" ]; then
        pkg_link="[${pkg}](${homepage})"
      else
        pkg_link="${pkg}"
      fi

      # Output table row
      echo "| ${pkg_link} | ${version} | ${description} |"
    done
}

# Check if README exists
if [ ! -f "$README" ]; then
  echo "Error: $README not found" >&2
  exit 1
fi

# Generate new table content
NEW_TABLE=$(generate_table)

# Check if markers exist in README
if ! grep -q "<!-- BEGIN PACKAGE TABLE -->" "$README"; then
  echo "Error: Could not find <!-- BEGIN PACKAGE TABLE --> marker in $README" >&2
  echo "Please add the markers manually to indicate where the table should be inserted." >&2
  exit 1
fi

if ! grep -q "<!-- END PACKAGE TABLE -->" "$README"; then
  echo "Error: Could not find <!-- END PACKAGE TABLE --> marker in $README" >&2
  exit 1
fi

# Update README.md with new table
awk -v new_table="$NEW_TABLE" '
  /<!-- BEGIN PACKAGE TABLE -->/ {
    print
    print ""
    print new_table
    print ""
    skip=1
    next
  }
  /<!-- END PACKAGE TABLE -->/ {
    skip=0
  }
  !skip
' "$README" > "$TEMP_FILE"

# Replace original file
mv "$TEMP_FILE" "$README"

echo "âœ“ Updated $README with current package information"
